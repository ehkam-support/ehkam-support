<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>مساعد إحكام — دعم فني</title>
  <style>
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:#f6f7fb;color:#111;line-height:1.6;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",Tahoma,sans-serif
    }
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;z-index:5}
    .wrap{max-width:920px;margin:0 auto;padding:12px}
    h1{margin:0;font-size:18px}
    #chat{height:calc(100vh - 210px);overflow-y:auto;padding:16px 6px 8px}
    .msg{display:flex;gap:10px;margin:10px 0;align-items:flex-start}
    .bubble{padding:10px 14px;border-radius:14px;max-width:85%;background:#fff;border:1px solid #eee;word-wrap:break-word}
    .user .bubble{background:#0077ff;color:#fff;border-color:#0077ff;margin-inline-start:auto;border-bottom-left-radius:6px}
    .bot  .bubble{border-bottom-right-radius:6px}
    .menu{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .menu button{width:100%;text-align:right;border:1px solid #ddd;background:#fff;padding:12px 14px;border-radius:10px;cursor:pointer;font:inherit}
    .menu button:hover{border-color:#bbb}
    form{position:sticky;bottom:0;background:#fff;border-top:1px solid #eee}
    .row{display:flex;gap:8px;align-items:stretch}
    textarea{flex:1;resize:none;min-height:44px;max-height:140px;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font:inherit}
    button.send{padding:0 16px;border:1px solid #0077ff;background:#0077ff;color:#fff;border-radius:10px;cursor:pointer;font:inherit}
    .hint{font-size:12px;color:#666;margin-top:6px}
    footer{text-align:center;font-size:12px;color:#888;padding:8px 0 14px}
    .center{display:flex;gap:8px;flex-wrap:wrap}
    .center button{flex:1;min-width:110px}
    a{color:#0077ff}
  </style>
</head>
<body>
  <header><div class="wrap"><h1>مساعد إحكام — دعم فني</h1></div></header>

  <div class="wrap"><div id="chat" aria-live="polite" aria-label="منطقة المحادثة"></div></div>

  <form id="composer" autocomplete="off">
    <div class="wrap">
      <div class="row">
        <textarea id="input" placeholder="كيف أساعدك؟"></textarea>
        <button class="send" id="send" type="submit">إرسال</button>
      </div>
      <div class="hint">تلميح: اكتب رقم الخدمة (1–5) أو اضغط الزر.</div>
    </div>
  </form>

  <footer><div class="wrap">صفحة واحدة — دعم فني ثابت لمنصة إحكام</div></footer>

  <script>
  (function () {
    "use strict";

    /* ===== مانع التكرار العالمي ===== */
    if (window.__EHKAM_BOOTED) return;
    window.__EHKAM_BOOTED = true;

    /* ===== النصوص ===== */
    const GREET_BOX = ["مرحبًا","أنا مساعدك بمنصة إحكام","يسعدني تقديم الخدمات والإجابات على كافة أسئلتك"].join("\n");
    const QUESTION_TITLE = "ما الخدمة التي تريد الاستفسار عنها";

    const REPLIES = {
      "1": "يمكنك متابعة طلبك عن طريق منصة إحكام أو التواصل مع مركز الاتصال الموحد/920035544 أو إرسال بريد إلكتروني على البريد الرسمي info@ehkaam.sa",
      "2": "مراجعة فرع الهيئة بالمنطقة المتواجد فيها برفقة المستندات المطلوبة ليتم رفع استدعاء من قبل موظف خدمة العملاء بفرع الهيئة عن طريق نظام معاملات.",
      "3": "يمكنك التوجه لأقرب فرع للهيئة العامة لعقارات الدولة بالمنطقة مع إحضار المستندات التالية:\n1- وكالة من جميع الورثة (مذكور بها مراجعة هيئة عقارات الدولة)\n2- صك حصر الورثة\n3- شهادة الوفاة\n4- البطاقة الشخصية\n5- كتاب معروض موجه لمدير الفرع لطلب النقل\n6- وجود حساب للموكل بمنصة إحكام",
      "4": "بشأن استرداد رسوم لمستفيدي الضمان الاجتماعي:\n1- البطاقة الشخصية\n2- مشهد من الضمان الاجتماعي\n3- التوجه لفرع الهيئة العامة لعقارات الدولة بفرع المنطقة.",
      "5": "يمكنك الاستعلام عن المعاملات من خلال الرابط التالي:\nhttps://spga.gov.sa/Enquiry-Service"
    };

    const MENU = [
      { key: "1", label: "1- استفسار عن طلب تملك" },
      { key: "2", label: "2- بشأن تسليم وثائق مطلوبة منك من منصة إحكام" },
      { key: "3", label: "3- بشأن نقل طلبات من مورث إلى أحد الورثة" },
      { key: "4", label: "4- بشأن استرداد رسوم لمستفيدي الضمان الاجتماعي" },
      { key: "5", label: "5- استعلام عن المعاملات" }
    ];

    /* ===== أدوات ===== */
    let chat, form, input;

    function el(tag, attrs = {}, ...children) {
      const e = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === "class") e.className = v;
        else if (k.startsWith("on") && typeof v === "function") e.addEventListener(k.slice(2), v);
        else e.setAttribute(k, v);
      }
      for (const c of children) e.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
      return e;
    }
    function toHTML(text) {
      const escaped = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      const withLinks = escaped.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
      return withLinks.replace(/\n/g,"<br>");
    }
    function addBubble(role, text) {
      const row = el("div", { class: "msg " + (role === "user" ? "user" : "bot") });
      const bubble = el("div", { class: "bubble" });
      bubble.innerHTML = toHTML(text);
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function showFirstBox(){ addBubble("bot", GREET_BOX); }
    function showSecondBox(){
      const row = el("div",{class:"msg bot"});
      const bubble = el("div",{class:"bubble"});
      bubble.appendChild(el("div",{}, QUESTION_TITLE + " :"));
      const menu = el("div",{class:"menu"});
      for (const item of MENU){
        menu.appendChild(el("button",{type:"button",onclick:()=>handleChoice(item.key)},item.label));
      }
      bubble.appendChild(menu);
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }
    function restartFlow(){ showFirstBox(); showSecondBox(); }

    function askAnother(){
      const row = el("div",{class:"msg bot"});
      const bubble = el("div",{class:"bubble"});
      bubble.appendChild(el("div",{},"هل تريد خدمة أخرى؟"));
      const btns = el("div",{class:"center",style:"margin-top:8px"});
      const yes = el("button",{type:"button",onclick:()=>{ addBubble("user","نعم"); restartFlow(); }},"نعم");
      const no  = el("button",{type:"button",onclick:()=>{ addBubble("user","لا"); addBubble("bot","سعدنا بخدمتكم"); }},"لا");
      btns.append(yes,no);
      bubble.appendChild(btns);
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function handleChoice(key){
      const item = MENU.find(m=>m.key===key);
      if(!item) return;
      addBubble("user", item.label);
      addBubble("bot", REPLIES[key]);
      askAnother();
    }

    function handleFreeText(txt){
      const t = txt.trim();
      if(/^[١-٥1-5]$/.test(t)){
        const map={"1":"1","2":"2","3":"3","4":"4","5":"5","١":"1","٢":"2","٣":"3","٤":"4","٥":"5"};
        handleChoice(map[t]); return;
      }
      if(/^نعم$/i.test(t)){ restartFlow(); return; }
      if(/^لا$/i.test(t)){ addBubble("bot","سعدنا بخدمتكم"); return; }
      addBubble("bot","يرجى اختيار رقم خدمة من (1–5) أو الضغط على أحد الأزرار بالأسفل.");
      showSecondBox();
    }

    function init(){
      chat = document.getElementById("chat");
      form = document.getElementById("composer");
      input = document.getElementById("input");
      if(!chat||!form||!input) return;

      form.addEventListener("submit",(e)=>{
        e.preventDefault();
        const txt = (input.value||"").trim();
        if(!txt) return;
        addBubble("user", txt);
        input.value = "";
        handleFreeText(txt);
      });

      restartFlow(); // تظهر مرة واحدة فقط الآن
    }

    // تشغيل مرّة واحدة فقط عند جاهزية DOM
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init, { once: true });
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
